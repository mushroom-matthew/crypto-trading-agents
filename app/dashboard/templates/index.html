<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Crypto Trading Dashboard</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #101418; color: #f5f7fa; }
    header { padding: 1.5rem; background: #18202b; border-bottom: 1px solid #2a3442; }
    h1, h2 { margin: 0 0 1rem 0; }
    main { padding: 1.5rem; display: grid; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); gap: 1.5rem; }
    section { background: #1c2430; border-radius: 8px; padding: 1rem 1.25rem; box-shadow: 0 2px 8px rgba(0,0,0,0.35); }
    table { width: 100%; border-collapse: collapse; }
    th, td { text-align: left; padding: 0.4rem; font-size: 0.95rem; }
    th { border-bottom: 1px solid #2f3947; }
    tr:nth-child(even) { background: #222b38; }
    button { background: #2f80ed; border: none; color: #fff; padding: 0.35rem 0.75rem; border-radius: 4px; cursor: pointer; }
    button.stop { background: #eb5757; }
    button:disabled { opacity: 0.5; cursor: not-allowed; }
    .status-pill { border-radius: 999px; padding: 0.15rem 0.6rem; font-size: 0.85rem; display: inline-block; }
    .running { background: #1b5e20; }
    .stopped { background: #b71c1c; }
    ul { margin: 0; padding-left: 1.3rem; }
    .error { color: #ffb4a2; font-size: 0.9rem; margin-top: 0.5rem; }
    code { background: #111722; padding: 0.15rem 0.3rem; border-radius: 4px; font-size: 0.85rem; }
  </style>
</head>
<body>
  <header>
    <h1>Crypto Trading Supervisor</h1>
    <p>Monitor agents, manage portfolios, and keep humans in control.</p>
  </header>

  <main>
    <section>
      <h2>Process Supervisor</h2>
      {% if not supervisor_enabled %}
        <p class="error">Process controls disabled (set <code>DASHBOARD_ENABLE_SUPERVISOR=1</code> to enable). Docker Compose services continue to run independently.</p>
      {% endif %}
      <table id="process-table">
        <thead>
          <tr>
            <th>Process</th>
            <th>Status</th>
            <th>PID</th>
            <th>Actions</th>
            <th>Logs</th>
          </tr>
        </thead>
        <tbody>
          {% for proc in processes %}
          <tr data-name="{{ proc.name }}">
            <td>{{ proc.name }}</td>
            <td>
              <span class="status-pill {{ 'running' if proc.running else 'stopped' }}">
                {{ 'running' if proc.running else 'stopped' }}
              </span>
            </td>
            <td>{{ proc.pid if proc.pid else '—' }}</td>
            <td>
              <button class="start" {{ 'disabled' if proc.running else '' }} onclick="startProcess('{{ proc.name }}')">Start</button>
              <button class="stop" {{ '' if proc.running else 'disabled' }} onclick="stopProcess('{{ proc.name }}')">Stop</button>
            </td>
            <td>
              {% if proc.log_path %}
                <code>{{ proc.log_path }}</code>
                {% if proc.last_start_error %}
                  <div class="error">Last error: {{ proc.last_start_error }}</div>
                {% endif %}
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section>
      <h2>Portfolios & Wallets</h2>
      {% if db_error %}
        <div class="error">Database unavailable: {{ db_error }}</div>
      {% endif %}
      <table>
        <thead>
          <tr>
            <th>Wallet</th>
            <th>Account</th>
            <th>Portfolio</th>
            <th>Tradeable %</th>
            <th>Balances</th>
          </tr>
        </thead>
        <tbody id="wallet-table">
          {% for wallet in wallets %}
          <tr>
            <td>{{ wallet.name }} (#{{ wallet.wallet_id }})</td>
            <td>{{ wallet.coinbase_account_id or '—' }}</td>
            <td>{{ wallet.portfolio_id or '—' }}</td>
            <td>{{ wallet.tradeable_fraction }}</td>
            <td>
              {% if wallet.balances %}
                {% for bal in wallet.balances %}
                  {{ bal.currency }}: {{ bal.available }}{% if not loop.last %}, {% endif %}
                {% endfor %}
              {% else %}
                —
              {% endif %}
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </section>

    <section>
      <h2>Agent Supervisor</h2>
      <p>Use the controls above to manage execution, broker, and judge agents. Future versions will surface Temporal workflow health and alerts.</p>
    </section>

    <section>
      <h2>Backlog</h2>
      <ul>
        {% for item in backlog %}
        <li>{{ item }}</li>
        {% endfor %}
      </ul>
    </section>
  </main>

  <script>
    async function refreshProcesses() {
      const resp = await fetch("/api/processes");
      const data = await resp.json();
      const tbody = document.querySelector("#process-table tbody");
      tbody.innerHTML = "";
      data.forEach(proc => {
        const row = document.createElement("tr");
        row.dataset.name = proc.name;
        const logContent = proc.log_path
          ? `<code>${proc.log_path}</code>${proc.last_start_error ? `<div class="error">Last error: ${proc.last_start_error}</div>` : ""}`
          : "—";
        row.innerHTML = `
          <td>${proc.name}</td>
          <td><span class="status-pill ${proc.running ? "running" : "stopped"}">${proc.running ? "running" : "stopped"}</span></td>
          <td>${proc.pid || "—"}</td>
          <td>
            <button class="start" ${proc.running ? "disabled" : ""} onclick="startProcess('${proc.name}')">Start</button>
            <button class="stop" ${proc.running ? "" : "disabled"} onclick="stopProcess('${proc.name}')">Stop</button>
          </td>
          <td>${logContent}</td>`;
        tbody.appendChild(row);
      });
    }

    async function startProcess(name) {
      await fetch(`/api/processes/${name}/start`, { method: "POST" });
      await refreshProcesses();
    }

    async function stopProcess(name) {
      await fetch(`/api/processes/${name}/stop`, { method: "POST" });
      await refreshProcesses();
    }
  </script>
</body>
</html>
