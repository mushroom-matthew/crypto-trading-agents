<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Trading Ops UI</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { margin-bottom: 4px; }
    .banner { font-weight: bold; margin-bottom: 12px; }
    .section { margin-bottom: 20px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; }
    th { background: #f4f4f4; }
    .reason { font-family: monospace; }
  </style>
</head>
<body>
  <h1>Trading Ops</h1>
  <div class="banner" id="status"></div>

  <div class="section">
    <h2>Workflows</h2>
    <table id="workflows">
      <thead><tr><th>Run</th><th>Status</th><th>Last Updated</th><th>Mode</th><th>Plan</th><th>Judge</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Block Reasons</h2>
    <table id="blocks">
      <thead><tr><th>Reason</th><th>Count</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <div class="section">
    <h2>Recent Fills</h2>
    <table id="fills">
      <thead><tr><th>Order</th><th>Symbol</th><th>Side</th><th>Qty</th><th>Price</th><th>Time</th></tr></thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    async function fetchJson(url) {
      const res = await fetch(url);
      return await res.json();
    }
    async function refresh() {
      const status = await fetchJson('/status');
      document.getElementById('status').textContent = `${status.banner} live_ack=${status.live_trading_ack}`;

      const runs = await fetchJson('/workflows');
      const wbody = document.querySelector('#workflows tbody');
      wbody.innerHTML = '';
      runs.forEach(run => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${run.run_id}</td><td>${run.status}</td><td>${run.last_updated}</td><td>${run.mode}</td><td>${run.latest_plan_id || ''}</td><td>${run.latest_judge_id || ''}</td>`;
        wbody.appendChild(tr);
      });

      const blocks = await fetchJson('/block_reasons');
      const bbody = document.querySelector('#blocks tbody');
      bbody.innerHTML = '';
      (blocks.reasons || []).forEach(r => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td class="reason">${r.reason}</td><td>${r.count}</td>`;
        bbody.appendChild(tr);
      });

      const fills = await fetchJson('/fills');
      const fbody = document.querySelector('#fills tbody');
      fbody.innerHTML = '';
      fills.forEach(f => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${f.order_id}</td><td>${f.symbol}</td><td>${f.side}</td><td>${f.qty}</td><td>${f.price}</td><td>${f.ts}</td>`;
        fbody.appendChild(tr);
      });
    }
    refresh();
    setInterval(refresh, 5000);
  </script>
</body>
</html>
