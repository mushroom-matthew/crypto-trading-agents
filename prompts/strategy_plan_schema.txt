STRATEGYPLAN SCHEMA (SHARED)

CRITICAL - Available Timeframes Constraint:
- The input includes "available_timeframes" in global_context listing which timeframes are loaded (e.g., ["5m", "1h", "4h"]).
- You may ONLY reference cross-timeframe indicators (tf_<timeframe>_<field>) for timeframes listed in available_timeframes.
- Triggers referencing unavailable timeframes will be BLOCKED and never fire.
- If only one timeframe is available, use ONLY direct indicators (close, ema_short, rsi_14) without tf_ prefixes.
- When multiple timeframes are available, use tf_<timeframe>_ prefixes for cross-timeframe confirmation.

Allowed Rule Identifiers (entry_rule/exit_rule/hold_rule may ONLY use these):
- Base indicators: symbol, timeframe, close, volume, volume_multiple, sma_short, sma_medium, sma_long, ema_short, ema_medium, ema_long, rsi_14, macd, macd_signal, macd_hist, atr_14, roc_short, roc_medium, realized_vol_short, realized_vol_medium, donchian_upper_short, donchian_lower_short, bollinger_upper, bollinger_lower, cycle_high_200, cycle_low_200, cycle_range_200, cycle_position, fib_236, fib_382, fib_500, fib_618, fib_786, last_expansion_pct, last_contraction_pct, expansion_contraction_ratio, ema_fast, ema_very_fast, realized_vol_fast, ewma_vol, vwap, vwap_distance_pct, vol_burst.
- Candlestick morphology identifiers: candle_body_pct, candle_upper_wick_pct, candle_lower_wick_pct, candle_strength, is_bullish, is_bearish, is_doji, is_hammer, is_shooting_star, is_pin_bar, is_bullish_engulfing, is_bearish_engulfing, is_inside_bar, is_outside_bar, is_impulse_candle.
- Higher-timeframe structural anchors: htf_daily_open, htf_daily_high, htf_daily_low, htf_daily_close, htf_prev_daily_high, htf_prev_daily_low, htf_prev_daily_open, htf_daily_atr, htf_daily_range_pct, htf_price_vs_daily_mid, htf_5d_high, htf_5d_low, htf_prev_daily_mid.
- Derived indicators: bollinger_middle, trend_state, vol_state.
- Position fields: position, is_flat, is_long, is_short, position_qty, position_value, entry_price, avg_entry_price, entry_side, position_opened_at.
- PnL and time-in-trade: unrealized_pnl_pct, unrealized_pnl_abs, unrealized_pnl, position_pnl_pct, position_pnl_abs, position_age_minutes, position_age_hours, holding_minutes, holding_hours, time_in_trade_min, time_in_trade_hours.
- Market-structure fields: nearest_support, nearest_resistance, distance_to_support_pct, distance_to_resistance_pct, trend, recent_tests.
- Cross-timeframe fields: tf_<timeframe>_<field> for any available_timeframes, including tf_<timeframe>_trend_state, tf_<timeframe>_vol_state, tf_<timeframe>_bollinger_middle.
- Numeric suffix aliases are allowed: any indicator ending in _NN may be referenced without the suffix (e.g., rsi_14 -> rsi, atr_14 -> atr, fib_236 -> fib). Aliases also work with tf_<timeframe>_ prefixes.

You MUST include the following top-level keys in every response:
- generated_at (ISO 8601 timestamp string)
- valid_until (ISO 8601 timestamp string)
- regime (one of: bull, bear, range, high_vol, mixed)
- risk_constraints (object)
- sizing_rules (array)
- triggers (array; can be empty but must exist)

Trigger schema (each item in triggers MUST include these keys):
- id (string)
- symbol (string, e.g., "BTC-USD")
- category (trend_continuation | reversal | volatility_breakout | mean_reversion | emergency_exit | other)
- confidence_grade (A | B | C)
- direction (long | short | exit)
- timeframe (e.g., "1h")
- entry_rule (string expression - NO subscript syntax like indicator[-1])
- exit_rule (string expression - NO subscript syntax like indicator[-1], can be empty for emergency exit)
- stop_loss_pct (REQUIRED for short entries): percentage-based stop distance (e.g., 2.0 means 2% stop)

IMPORTANT - Short entries:
- All short triggers MUST include stop_loss_pct. Short entries without stop_loss_pct will be BLOCKED.
- Example short trigger: {"direction": "short", "stop_loss_pct": 2.5, ...}

IMPORTANT - Cross-Timeframe ATR Tautology:
- Comparing ATR across timeframes directly (e.g., tf_1d_atr > tf_4h_atr) is ALWAYS TRUE because higher-timeframe ATR aggregates more price movement. This is a tautology that causes emergency exits to fire on every bar.
- CORRECT: Use ratio comparisons: tf_1d_atr > 2.5 * tf_4h_atr (checks if daily ATR is 2.5x larger than expected)
- CORRECT: Use same-timeframe comparisons: atr_14 > sma_medium * 0.03 (checks volatility relative to price)
- WRONG: tf_1d_atr > tf_4h_atr (always true — will be flagged as compile-time warning)
- WRONG: tf_4h_atr > tf_1h_atr (always true)

IMPORTANT - Exit Binding Constraint:
- Exit rules only close positions opened by triggers in the SAME category.
- A "trend_continuation" exit will NOT close a position opened by a "reversal" entry.
- CORRECT: Each symbol's entries should be in ONE category, with matching exits.
- WRONG: BTC-USD entries split across "trend_continuation" and "reversal" — exits won't cross-close.
- If you need multiple entry strategies for one symbol, use a single category or add explicit risk_reduce/risk_off exits that cover all positions.

Do NOT use these keys in triggers: type, risk_grade.

Risk constraints MUST include:
- max_position_risk_pct
- max_symbol_exposure_pct
- max_portfolio_exposure_pct
- max_daily_loss_pct
- max_daily_risk_budget_pct (optional)

Sizing rules MUST include one entry per symbol. If unsure, use:
{ "symbol": "<SYMBOL>", "sizing_mode": "fixed_fraction", "target_risk_pct": <max_position_risk_pct> }

IMPORTANT - Hold Rule Calibration:
- hold_rule (optional field on triggers) keeps a position open when exit_rule fires. If hold_rule evaluates True, the exit is suppressed.
- A degenerate hold rule can suppress ALL normal exits, forcing emergency exits as the only way out.
- BAD hold rule: "rsi_14 > 45" — RSI is above 45 most of the time, suppresses nearly all exits
- BAD hold rule: single condition only (e.g., "close > sma_short") — too easy to be always true
- GOOD hold rule: "rsi_14 > 60 and close > sma_medium and atr_14 < 500" — multiple conditions, harder to be always true
- If you use hold_rule, ensure it can actually become False within normal market conditions.
- NOTE: Degenerate hold rules (single-condition or low-threshold RSI) will be AUTO-STRIPPED at compile time. Write quality hold rules or omit them entirely.

IMPORTANT - Trigger Fire Rate Calibration:
- Each entry trigger should fire approximately 1-3 times per day on 1h bars.
- A trigger with 0 fires after 48+ evaluations is considered "dead" — its conditions are too restrictive.
- Use is_flat instead of "not is_long" for position filters (is_flat is always available).
- Calibrate thresholds: rsi_14 < 30 fires <5% of bars (restrictive); rsi_14 < 40 fires ~10-15% (moderate).
- Avoid combining 4+ conditions with "and" — each additional condition multiplicatively reduces fire rate.

Optional fields (if provided) MUST follow these schemas:
- regime_alerts: array of objects with keys:
  indicator (string), threshold (number), direction (above|below|crosses), symbol (string), interpretation (string), priority (high|medium|low)
- sizing_hints: array of objects with keys:
  symbol (string), suggested_risk_pct (number), rationale (string)
- max_triggers_per_symbol_per_day: integer
- trigger_budgets: object mapping symbol -> integer (per-symbol trigger caps)

CANDLESTICK PATTERN IDENTIFIERS (scalar/boolean):
  candle_body_pct         — body as fraction of range (0=doji, 1=marubozu)
  candle_upper_wick_pct   — upper wick fraction of range
  candle_lower_wick_pct   — lower wick fraction of range
  candle_strength         — body / ATR (>1.0 = impulse move, <0.3 = indecision)
  is_bullish              — 1.0 if close > open
  is_bearish              — 1.0 if close < open
  is_doji                 — 1.0 if body_pct < 0.10 (indecision)
  is_hammer               — 1.0 if bullish reversal shape at low
  is_shooting_star        — 1.0 if bearish reversal shape at high
  is_pin_bar              — 1.0 if wick > 60% of range (either side)
  is_bullish_engulfing    — 1.0 if current bar engulfs prior bearish body
  is_bearish_engulfing    — 1.0 if current bar engulfs prior bullish body
  is_inside_bar           — 1.0 if current range inside prior bar (compression)
  is_outside_bar          — 1.0 if current range outside prior bar (expansion)
  is_impulse_candle       — 1.0 if body >= ATR threshold (decisive move)

CANDLESTICK USAGE GUIDANCE:
- Use boolean patterns as CONFIRMATION for entry/exit triggers, not as sole condition.
  Example: "is_hammer == 1 and close > nearest_support and rsi_14 < 40" (hammer + support + oversold)
- Evaluate boolean features as: is_hammer > 0.5 or is_hammer == 1 in rule expressions.
- candle_strength > 1.0 suggests an impulse move; use for breakout confirmation.
- is_inside_bar is a compression signal; combine with low BB bandwidth for setup detection.
- is_outside_bar at a key level often precedes a strong directional move.
- Two-bar patterns (engulfing, inside, outside) require prior bar — always available after bar 1.
- Pattern context matters: a hammer is bullish only at support or after a downtrend.
  Combine candle patterns with structural context, not in isolation.

HIGHER-TIMEFRAME STRUCTURAL ANCHOR IDENTIFIERS (prior completed daily session):
  htf_daily_high          — Prior session's high (key resistance)
  htf_daily_low           — Prior session's low (key support)
  htf_daily_open          — Prior session's open (intraday pivot reference)
  htf_daily_close         — Prior session's close (momentum reference)
  htf_prev_daily_high     — Session-before-prior's high (2-day lookback high)
  htf_prev_daily_low      — Session-before-prior's low (2-day lookback low)
  htf_daily_atr           — Daily ATR(14) (volatility normalizer for HTF)
  htf_daily_range_pct     — Prior session's range as % of close
  htf_price_vs_daily_mid  — (close - daily_mid) / daily_atr; ATR-normalized position
                            >0 = above prior midpoint, <0 = below, |value|>1 = far from mid
  htf_5d_high             — Rolling 5-session high (weekly proxy resistance)
  htf_5d_low              — Rolling 5-session low (weekly proxy support)
  htf_prev_daily_mid      — Midpoint of session-before-prior: (prev2_high + prev2_low) / 2

HTF STOP AND TARGET ANCHORING:
- Long stop below daily structure: close < htf_daily_low * 0.995
  (0.5% buffer below yesterday's low — prevents stop hunts from noise)
- Short stop above daily structure: close > htf_daily_high * 1.005
- Target at prior high: close > htf_daily_high * 0.998
  (approach target as exit rule — capture before resistance)
- Weekly proxy target: close > htf_5d_high * 0.995 for breakout targets
- Position context: htf_price_vs_daily_mid > 1.0 means far above daily midpoint
  (prefer exits over entries for longs at these levels)
  htf_price_vs_daily_mid < -1.0 means far below midpoint
  (prefer entries for longs — oversold relative to session structure)
- NOTE: htf_* fields are None before the second completed daily bar. Always combine
  with a fallback (e.g., "htf_daily_low is not None and close < htf_daily_low * 0.995 or close < sma_long * 0.97").
